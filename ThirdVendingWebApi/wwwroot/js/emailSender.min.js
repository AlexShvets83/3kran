function initEmailSender(){$("#mailTheme").dxTextBox({placeholder:"Тема сообщения...",onValueChanged:function(){checkMail()}});$("#mailBody").dxTextArea({placeholder:"Текст сообщения...",height:function(){return window.innerHeight/1.4-77},onValueChanged:function(){checkMail()},onInput:function(n){var i=n.element.find(":input:not([type=hidden])")[0].value,t=!0;i.trim()||(t=!1);checkMail(t)}}).dxTextArea("instance");$("#mailDestTable").dxDataGrid({dataSource:mailDestList,showRowLines:!0,keyExpr:"id",columnAutoWidth:!1,columnFixing:{enabled:!1},cellHintEnabled:!0,showBorders:!0,wordWrapEnabled:!1,selection:{mode:"none"},height:function(){return window.innerHeight/1.4-46},hoverStateEnabled:!0,rowAlternationEnabled:!0,loadPanel:{enabled:!0},paging:{pageSize:10},pager:{infoText:"Страница {0} из {1} ({2} пользователей)",showInfo:!0,visible:"always"},columns:[{fixed:!1,width:30,minWidth:30,type:"buttons",cssClass:"vert-btn-align",buttons:[{hint:"Удалить из списка адресатов",cssClass:"btn btn-secondary btn-sm btn-font text-white fa fa-minus",onClick:function(n){var t=n.row.data;mailDestList=jQuery.grep(mailDestList,function(n){return n!==t});chekMailList()}}]},{dataField:"lastName",allowSorting:!0,caption:"Фамилия/email",headerCellTemplate:function(n,t){setHeader(n,t)},cellTemplate:function(n,t){n.append("<div>"+t.value+"<\/div>");n.append("<div>"+t.data.email+"<\/div>")}},{dataField:"email",visible:!1},{allowSorting:!0,dataField:"role",caption:"Роль",cssClass:"vert-align",dataType:"string",headerCellTemplate:function(n,t){setHeader(n,t)},cellTemplate:function(n,t){n.append(`<div>${getNornRole(t.value)}</div>`);t.data.ownerEmeil&&n.append(`<div>${t.data.ownerEmeil}</div>`)},headerFilter:{dataSource:[{text:"Техник",value:["role","=","technician"]},{text:"Владелец",value:["role","=","owner"]},{text:"Адм. дилера",value:["role","=","dealer_admin"]},{text:"Дилер",value:["role","=","dealer"]},{text:"Админ",value:["role","=","admin"]}]}}]});$("#mailUsersTable").dxDataGrid({showRowLines:!0,keyExpr:"id",columnAutoWidth:!1,columnFixing:{enabled:!1},cellHintEnabled:!0,showBorders:!0,wordWrapEnabled:!1,selection:{mode:"none"},height:function(){return window.innerHeight/1.4},hoverStateEnabled:!0,rowAlternationEnabled:!0,loadPanel:{enabled:!0},searchPanel:{visible:!0,highlightCaseSensitive:!0,placeholder:"Поиск пользователя"},paging:{pageSize:10},pager:{infoText:"Страница {0} из {1} ({2} пользователей)",showInfo:!0,visible:"always"},columns:[{fixed:!1,width:32,minWidth:30,type:"buttons",cssClass:"vert-btn-align",buttons:[{hint:"Добавить в список адресатов",cssClass:"btn btn-success btn-sm btn-font text-white fa fa-plus",onClick:function(n){var t=n.row.data;const i=mailDestList.findIndex(n=>n.id===t.id);i>=0||(mailDestList.push(t),chekMailList())}}]},{dataField:"lastName",allowSorting:!0,caption:"Фамилия/email",headerCellTemplate:function(n,t){setHeader(n,t)},cellTemplate:function(n,t){n.append("<div>"+t.value+"<\/div>");n.append("<div>"+t.data.email+"<\/div>")}},{dataField:"email",visible:!1},{allowSorting:!0,dataField:"role",caption:"Роль",cssClass:"vert-align",dataType:"string",headerCellTemplate:function(n,t){setHeader(n,t)},cellTemplate:function(n,t){n.append(`<div>${getNornRole(t.value)}</div>`);t.data.ownerEmeil&&n.append(`<div>${t.data.ownerEmeil}</div>`)},headerFilter:{dataSource:[{text:"Техник",value:["role","=","technician"]},{text:"Владелец",value:["role","=","owner"]},{text:"Адм. дилера",value:["role","=","dealer_admin"]},{text:"Дилер",value:["role","=","dealer"]},{text:"Админ",value:["role","=","admin"]}]}}]});$("#mailTheme").dxTextBox("instance").option("isValid",!0);$("#mailDestTable").dxDataGrid("instance").option("dataSource",mailDestList);$.getJSON("/api/users/",null).then(function(n){$("#mailUsersTable").dxDataGrid("instance").option("dataSource",n)},function(n){(n.status===401||n.status===403)&&logout()})}function clearMailAll(){clearMailList();$("#mailTheme").dxTextBox("instance").option("value","");$("#mailBody").dxTextArea("instance").option("value","");checkMail()}function clearMailList(){mailDestList=[];chekMailList()}function chekMailList(){$("#mailDestTable").dxDataGrid("instance").option("dataSource",mailDestList);const n=document.getElementById("mailClearBtn");mailDestList.length>0?(n.disabled=!1,n.innerText=` Очистить список (${mailDestList.length})`):(n.disabled=!0,n.innerText=` Очистить список`);checkMail()}function checkMail(n){var i=!0,t;const r=$("#mailTheme").dxTextBox("instance").option("value");t=!0;const u=$("#mailBody").dxTextArea("instance").option("value");r.trim()||(i=!1);n||u.trim()||(t=!1);document.getElementById("mailSendBtn").disabled=mailDestList.length===0||!i||!t}function sendMail(){var t=!0,i=!0,n;const r=$("#mailTheme").dxTextBox("instance").option("value"),u=$("#mailBody").dxTextArea("instance").option("value");if(r.trim()||(t=!1),u.trim()||(i=!1),mailDestList===0||!t||!i){document.getElementById("mailSendBtn").disabled=!0;return}n=[];mailDestList.forEach(function(t){n.push(t.email)});const f={emailTheme:r,emailBody:u,addressees:n};$.postJSON(`/api/Email/sentMail`,f,null).then(function(){clearMailAll();$("#emailSend").modal("hide");return});clearMailAll();$("#emailSend").modal("hide")}var mailDestList=[];