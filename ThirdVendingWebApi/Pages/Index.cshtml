@page
@model IndexModel
@{
    ViewData["Title"] = "Index";
}
<style>
    html {
        visibility: hidden;
    }
</style>
<div class="row welcome" id="logForm">
    <!-- Контент -->
    <section class="col-12">
        <h4 class="text-center">Добро пожаловать в систему мониторинга<br/>«Третий кран»</h4>
        <p class="text-center">Для начала работы нужно войти в систему</p>

        <div class="welcome-form" id="loginForm">
            <div class="alert alert-danger" id="authenticationError" role="alert" style="display: none">
                <i class="fa fa-warning" aria-hidden="true">
                </i>&nbsp;&nbsp;Неверный email или пароль.
            </div>
            <div class="alert alert-warning" id="capsLock" role="alert" style="display: none">
                <i class="fa fa-warning" aria-hidden="true">
                </i>&nbsp;&nbsp;«CapsLock» включен.
            </div>

            <div id="formWidget"></div>

            <div class="form-inline">
                <button onclick="login_post()" class="btn btn-primary mb-2 mt-2 mr-4"><i class="fa fa-sign-in pr-2"></i>&nbsp;Войти</button>
                <a [routerLink]="['/', { outlets: { popup: 'reset/request'}}]"
                   class="text" title="Вы забыли пароль?">
                    Вы забыли пароль?
                </a>
            </div>
        </div>

        <div class="welcome-footer">
            <p class="text-center">У вас нет аккаунта? Создайте новый.</p>
            <a onclick="register()" class="btn btn-warning btn-block" role="link"><i class="fa fa fa-user-plus" aria-hidden="true"></i>&nbsp;&nbsp;Зарегистрироваться</a>
            <a href="http://3voda.ru/vopros-otvet" target="_blank" class="btn btn-info btn-block mt-3" role="link"><i class="fa fa-question-circle-o" aria-hidden="true"></i>&nbsp;&nbsp;Частые вопросы</a>
            <p>
                Актуальная информация о продукции, услугах и деятельности компании размещена на нашем сайте
                <a href="http://3voda.ru" target="top" title="Перейти на сайт компании">
                    <span style="text-decoration: underline; color: #333333;">
                        <b>3voda.ru</b>
                    </span>
                </a>. Будьте в курсе событий!
            </p>
        </div>
        <br/>
    </section>
</div>

<script>
    function register() {
        window.location.replace("/Account/Register");
    }

    window.onload = function() {
        var request = $.getJSON('/api/account', null);

        request.done(function(data) {
            sessionStorage.setItem(accountKey, JSON.stringify(data));
            window.location.replace("/Account/Settings");
        });
    }
    //$(function() {
    //    var request = $.getJSON('/api/account', null);

    //    request.done(function(data) {
    //        account = data;
    //        window.location.replace("/Account/Settings");
    //    });

    //});

    $(document).ready(
        function () {
            document.getElementsByTagName("html")[0].style.visibility = "visible";
            check_capslock_form($('#logForm')); //applies the capslock check to all input tags
        }
    );

    document.onkeydown = function (e) { //check if capslock key was pressed in the whole window
        e = e || event;
        //if (typeof (window.lastpress) === 'undefined') { window.lastpress = e.timeStamp; }
        //if (typeof (window.capsLockEnabled) !== 'undefined') {
        if (e.keyCode === 20) {// && e.timeStamp > window.lastpress + 50) {
            window.capsLockEnabled = !window.capsLockEnabled;
            $('#capsLock').toggle();
        }
        //window.lastpress = e.timeStamp;
        //sometimes this function is called twice when pressing capslock once, so I use the timeStamp to fix the problem
        //}

    };

    function check_capslock(e) { //check what key was pressed in the form
        var s = String.fromCharCode(e.keyCode);
        if (s.toUpperCase() === s && s.toLowerCase() !== s && !e.shiftKey) {
            //window.capsLockEnabled = true;
            $('#capsLock').show();
        }
        else {
            //window.capsLockEnabled = false;
            $('#capsLock').hide();
        }
    }

    function check_capslock_form(where) {
        if (!where) { where = $(document); }
        where.find('input,select,div').each(function () {
            if (this.type !== "hidden") {
                $(this).keypress(check_capslock);
            }
        });
    }

    function setAuth(dt) {
        var nst = "none";
        if (dt === false) nst = "block";
        document.getElementById("authenticationError").style.display = nst;
    }

    function login_post() {
        var valid = $('#formWidget').dxForm('instance').validate();
        if (valid.isValid === false) return;

        setAuth(true);

        var data = $('#formWidget').dxForm('instance').option('formData');

        var request = $.postJSON('/api/Authenticate', data, postOk);

        request.fail(function() {
            setAuth(false);
        });
    }

    function postOk(data) {
        sessionStorage.setItem(tokenKey, data.id_token);
        window.location.replace("/Account/Settings");
    }

    $(function() {
        $("#formWidget").dxForm({
            formData: {
                username: "",
                password: ""
            },
            items: [
                {
                    dataField: "username",
                    label: {
                        text: "Email",
                        visible: false
                    },
                    editorOptions: {
                        placeholder: "Введите Email"
                    },
                    validationRules: [
                        {
                            type: "required",
                            message: "Введите Email"
                        }
                    ]
                },
                {
                    dataField: "password",
                    label: {
                        text: "Пароль",
                        visible: false
                    },
                    editorOptions: {
                        placeholder: "Введите пароль",
                        mode: "password"
                    },
                    validationRules: [
                        {
                            type: "required",
                            message: "Введите пароль"
                        }
                    ]
                }
            ]
        });
    });
</script>
