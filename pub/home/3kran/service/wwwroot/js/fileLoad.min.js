function initFilePanel(){var i=314572800,n,t;const r=sessionStorage.getItem(accountKey);r||window.location.replace("/Account/Login");const f=JSON.parse(r),u=f.role;$.getJSON("/api/appSettings",null).then(function(n){i=n.fileMaxUploadLenght*1048576});$("#chkFile").change(function(){document.getElementById("deleteFileBtn").disabled=!$(this).prop("checked")});n=u.toLowerCase().indexOf("super")>=0||u.toLowerCase()==="admin";document.getElementById("div_files").innerHTML=null;$("#progress .bar").css("width","0");t=32;n&&(t=96);$("#fileLoadTable").dxDataGrid({dataSource:[],showColumnLines:!1,showRowLines:!0,keyExpr:"id",columnAutoWidth:!0,columnFixing:{enabled:!1},cellHintEnabled:!0,showBorders:!0,wordWrapEnabled:!1,selection:{mode:"none"},focusedRowEnabled:!0,height:function(){return window.innerHeight/1.4-46},hoverStateEnabled:!0,rowAlternationEnabled:!0,loadPanel:{enabled:!0},paging:{pageSize:10},pager:{infoText:"Страница {0} из {1} ({2} файлов)",showInfo:!0,visible:"always"},headerFilter:{visible:!0},columns:[{allowSorting:!0,allowHeaderFiltering:!1,dataField:"fileDate",caption:"Дата",dataType:"date",format:"dd.MM HH:mm",headerCellTemplate:function(n,t){setHeader(n,t)}},{dataField:"name",allowSorting:!0,allowHeaderFiltering:!1,caption:"Имя/Описание",headerCellTemplate:function(n,t){setHeader(n,t)},cellTemplate:function(n,t){n.append(`<div>${t.value}</div>`);n.append(`<div>${t.data.description}</div>`)}},{width:t,fixed:!1,allowSorting:!0,type:"buttons",alignment:"center",cssClass:"vert-btn-align",caption:"",buttons:[{hint:"Изменить описание",visible:function(){return n},cssClass:"btn btn-primary btn-sm btn-font text-white fa fa-pencil",onClick:function(n){const t=n.row.data,r=t.id;if(r){document.getElementById("editFileId").value=t.id;document.getElementById("fileDsc").value=t.description;const i=document.getElementById("editFileError");i.style.display="none";i.innerText=null;$("#editFilePopup").modal("toggle")}}},{hint:"Скачать",cssClass:"btn btn-primary btn-sm btn-font text-white fa fa-download",onClick:function(n){const i=n.row.data,t=i.id;t&&(window.location=`/api/files/${t}`)}},{hint:"Удалить",visible:function(){return n},cssClass:"btn btn-danger btn-sm btn-font text-white fa fa-remove",onClick:function(n){const t=n.row.data,r=t.id;if(r){const u=`<div>Вы действительно хотите удалить</div>${`<div>файл "${t.name}" из системы?</div>`}`;document.getElementById("deleteFileCaption").innerHTML=u;document.getElementById("deleteFileId").value=t.id;const i=document.getElementById("deleteFileError");$("#deleteFileBtn").prop("disabled",!0);$("#chkFile").prop("checked",!1);i.style.display="none";i.innerText=null;$("#deleteFilePopup").modal("toggle")}}}]},{width:38,dataField:"visible",allowSorting:!0,alignment:"center",cssClass:"vert-btn-align",caption:null,visible:n,cellTemplate:function(n,t){const r=t.data;var i;i=r.visible?'<a href="#" class="btn btn-success btn-sm btn-font fa fa-eye" onclick="setFileVisible(false)" data-toggle="tooltip" title="Сделать невидимым"><\/a>':'<a href="#" class="btn btn-secondary btn-sm btn-font fa fa-eye-slash" onclick="setFileVisible(true)" data-toggle="tooltip" title="Сделать видимым"><\/a>';n.append(i)},headerFilter:{dataSource:[{text:"Видимые",value:["visible","=",!0],template:function(){return'<i class="fa fa-eye text-success" aria-hidden="true"><\/i>&nbsp;Видимые'}},{text:"Невидимые",value:["visible","=",!1],template:function(){return'<i class="fa fa-eye-slash text-secondary" aria-hidden="true"><\/i>&nbsp;Невидимые'}}]}}]});getFiles();n?(document.getElementById("fileUploadWidget").style.display="block",$("#fileUploadWidget").fileupload({singleFileUploads:!0,autoUpload:!1,beforeSend:function(n){const t=sessionStorage.getItem(tokenKey);n.setRequestHeader("Authorization",`Bearer ${t}`)},add:function(n,t){const r=[],u=t.originalFiles[0].size;u&&u>i&&r.push("Filesize is too big");r.length>0?alert(r.join("\n")):t.submit()},done:function(n,t){const i=t.result.files;$(`<p style="color: green;">${i.name}<i class="elusive-ok" style="padding-left:10px;"/> - Size: ${i.size} byte</p>`).appendTo("#div_files");getFiles()},fail:function(n,t){$.each(t.messages,function(n,t){$(`<p style="color: red;">Upload file error: ${t}<i class="elusive-remove" style="padding-left:10px;"/></p>`).appendTo("#div_files")})},progressall:function(n,t){const i=parseInt(t.loaded/t.total*100,10);$("#progress .bar").css("width",i+"%")}})):document.getElementById("fileUploadWidget").style.display="none"}function getFiles(){$.getJSON("/api/files",null).then(function(n){$("#fileLoadTable").dxDataGrid("instance").option("dataSource",n)})}function setFileVisible(n){const t=$("#fileLoadTable").dxDataGrid("instance"),i=t.option("focusedRowKey");$.putJSON(`/api/files/setVisible/${i}`,n?!0:!1,null).then(function(){getFiles()})}function deleteFile(){const t=document.getElementById("deleteFileId").value;var n=document.getElementById("deleteFileError");n.style.display="none";$.deleteObj(`/api/files/${t}`).then(function(){$("#deleteFilePopup").modal("hide");getFiles()},function(t){if(t.readyState===4&&t.status===200)$("#deleteFilePopup").modal("hide"),getFiles();else{const i=t.responseText?t.responseText:`Error${t.status}`;n.innerHTML=`<i class="fa fa-warning" aria-hidden="true"></i>&nbsp;&nbsp;${i}`;n.style.display="block"}})}function editFile(){const t=document.getElementById("editFileId").value;var n=document.getElementById("editFileError");n.style.display="none";const i=document.getElementById("fileDsc").value;$.putJSON(`/api/files/${t}`,i,null).then(function(){$("#editFilePopup").modal("hide");getFiles()},function(t){if(t.readyState===4&&t.status===200)$("#editFilePopup").modal("hide"),getFiles();else{const i=t.responseText?t.responseText:`Error${t.status}`;n.innerHTML=`<i class="fa fa-warning" aria-hidden="true"></i>&nbsp;&nbsp;${i}`;n.style.display="block"}})}